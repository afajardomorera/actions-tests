name: Autoapprove PR
on:
  issue_comment:
    types: [created]
jobs:
  create-pr-update-image-and-merge:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - id: checkout
        name: "Check Out del Código"
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: "Definir Nombre Único de Rama"
        id: definir_nombre_rama
        run: |
          echo $(date +'%Y%m%d%H%M%S')
          echo "rama=deploy$(date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT
      
      - id: crear_rama_para_despliegue_auto
        name: "Crear Rama para despliegue automático"
        run: |
          git config user.name "action-tests[bot]"
          git config user.email "action-tests[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.definir_nombre_rama.outputs.rama}} main
          git push --set-upstream origin ${{ steps.definir_nombre_rama.outputs.rama}}
  
      - id: checkout_pr
        name: Check Out y cambio a rama ${{ steps.definir_nombre_rama.outputs.rama}}
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.definir_nombre_rama.outputs.rama}}
          
      - id: actualizar_image_micro
        name: "[EKS] Actualizar imagen de microservicio"
        run: |
          sudo apt-get install sed
          git config user.name "action-tests[bot]"
          git config user.email "action-tests[bot]@users.noreply.github.com"
          sed -i 's/IMAGEN222.*/IMAGEN333:prueba333/' ./terraform.tfvars
          git status
          git add -A
          git commit -m "Updated file for deploying image: ${{ steps.definir_nombre_rama.outputs.rama }}!!"

      - name: Crear Pull Request
        id: crear_pull_request
        uses: peter-evans/create-pull-request@v4
        with:
          branch: ${{ steps.definir_nombre_rama.outputs.rama }}
          base: main
          title: "[DEPLOY BY COMMENT] Automatic PR ${{ steps.definir_nombre_rama.outputs.rama }}"
          body:
            Prueba de PR automática - ${{ steps.definir_nombre_rama.outputs.rama }}
          token: ${{ secrets.REPO_SCOPED_TOKEN }}
          delete-branch: false
      
      - name: Esperar hasta que se ejecuten los checks de estado
        uses: fountainhead/action-wait-for-check@v1.1.0
        id: esperar_por_checks_de_estado
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "main-pull-request / simulation"
          ref: ${{ steps.crear_pull_request.outputs.pull-request-head-sha }}   
      
      - id: mergear_pull_request
        name: Mergear Pull Request
        uses: juliangruber/merge-pull-request-action@v1.1.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ env.PULL_REQUEST_NUMBER }}
          method: squash
      
      - id: values_for_message
        name: Establecer valores para el mensaje
        env:
          FULL_REPO_NAME: None
        run: |
          echo "FULL_REPO_NAME=${{ github.event.repository.full_name }}" >> $GITHUB_ENV
          echo "MENSAJE=Puede consultar el estado del despliegue <a href=\"https://github.com/${{ github.event.repository.full_name }}/pull/$PULL_REQUEST_NUMBER\">aquí</a>"
      
      - id: add_process_message
        name: add_process_message
        uses: actions/github-script@v6
        with:
          script: |
            const octokit = new Octokit({
              auth: '${{ secrets.GITHUB_TOKEN  }}
            }
            
            await octokit.request('POST' /repos/afajardomorera/actions-tests/issues/43/comments', {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: process.env.MENSAJE
            });
